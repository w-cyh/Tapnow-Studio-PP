# Tapnow Studio 版本更新历史

本文档记录了 Tapnow Studio 近期的所有关键更新、修复和功能改进。

#### 2026-02-10 开发中改动（3.8.7-rc2）
- **[版本]** RC 迭代由 `3.8.7-rc1` 递增到 `3.8.7-rc2`，用于分离本轮交付与文档同步。
- **[核心]** 节点统一输入输出协议 V1：新增 `NodeIOEnvelope` 运行时结构与校验，连线读取统一到 `text/media` 双通道。
- **[核心]** 文本连线兼容扩展：文本消费端由“仅 text-node”扩展为“统一读取上游 envelope 文本输出”。
- **[核心]** 标准多图批次接口通道：模型库新增 `parallel_aggregate / standard_batch` 切换；标准批次模式可单任务请求 `2/4/9` 张。
- **[核心]** 批次回退策略：当 `standard_batch` 失败或返图数量不足时，自动回退 `parallel_aggregate`，保持同任务窗口聚合。
- **[文档]** README 补充 Docker 实操说明：启动/日志/停止/健康检查/端口冲突处理与双服务说明。

#### 2026-02-10 维护改动（3.8.6 文档/部署）
- **[修复]** Docker 健康检查地址由 `/` 调整为 `/ping`，避免容器被误判为 unhealthy。
- **[修复]** Docker 启动参数固定为 `python tapnow-server-full.py -d /app/data`，与 compose 数据卷持久化目录对齐。
- **[新增]** Docker 前后端双容器部署：`docker-compose.yml` 新增 `web` 服务（`8080`）并保留 `tapnow` 服务（`9527`）。
- **[新增]** 前端容器构建链路：新增 `Dockerfile.web` + `docker/nginx/default.conf`，用于托管 `dist` 并支持 SPA fallback。
- **[文档]** 新增/更新 Docker 文档：`localserver/Docker_README.md`、`README.md`、`localserver/LocalServer_README.md`。

#### 2026-02-09 已验证（3.8.6）
- **[版本]** 正式发布 `3.8.6`，收敛并验收 `rc0` 至 `rc10` 的核心改动。
- **[新增]** 多图并发主目标落地：节点支持 `1/2/4/9` 张并发、并发间隔配置、同任务窗口聚合显示。
- **[新增]** 智能分镜主目标落地：`LLM拆脚本/LLM拆小说/LLM自定义`、卡片/表格双视图、Markdown 表格导入、提示词汇总回填。
- **[新增]** Antigravity 图像编辑适配：模型库支持 `自动/仅Text-to-Image/仅Edit` 路由，Edit 路径支持 `image1/image2/...` 多参考图与 `mask`。
- **[修复]** 参数体系与模型库链路：默认参数、禁用交互、默认张数、导入导出与 API 配置备份保持一致。
- **[修复]** 稳定性收敛：降级保存手势报错、Lightbox 导航/占位加载、模型复制串参与状态识别。

#### 2026-02-07 开发中改动（3.8.6-rc0）
- **[版本]** 开工版本切换为 `3.8.6-rc0`（构建产物将按该版本号命名）。
- **[修复]** 本地缓存多图映射修复：禁止把单个 `localCacheUrl` 扩散到多图全槽位，避免第 4 张预览/拖拽落到第 1 张。
- **[修复]** 多图历史自检修复：检测到“多图全部映射同一缓存文件”时清空错误映射并重建，降低 Lightbox 错图概率。
- **[修复]** 黑屏报错 `Cannot access 'zo' before initialization`：修复缓存映射校验函数 TDZ（声明顺序前置）。
- **[流程]** `scripts/finish_task.ps1` 默认接入 `scripts/smoke_test.ps1`，构建后运行时黑屏检测失败即中断。

#### 2026-02-08 开发中改动（3.8.6-rc2）
- **[修复]** Lightbox 历史上下切组：去除“无 id 不可导航”硬拦截，新增 URL 锚点匹配，修复画布来源“上下切组无效”。
- **[修复]** Lightbox 纵向切组强制重置到第 1 张（`selectedMjImageIndex=0`），修复跨组索引污染导致的乱跳。
- **[修复]** BizyAir/Gemini 请求模板：远端 Provider 下自动把本地缓存/本地代理 URL 还原为源 URL，并清理空 `input_values/inputs` 字段，降低任务直接 Failed。

#### 2026-02-08 开发中改动（3.8.6-rc3）
- **[修复]** Lightbox 多图源统一：灯箱导航改为统一读取 `mjImages/output_images`，修复 BizyAir zimage 历史项 `mjCount=0` 导致的组内无法左右切换。
- **[修复]** Lightbox 历史锚点匹配补齐：历史上下切组加入 `output_images` 候选匹配，修复上下切组无效/乱跳。
- **[修复]** Lightbox 上下切组增强兜底：snapshot 失效时自动回退实时历史列表，并跳过同 id 候选，提升跨组切换命中率。
- **[调试]** Lightbox 上下切组新增结构化日志 `[Lightbox][history_nav]`，输出阻塞原因（无候选/锚点失败/同组等）便于复现定位。
- **[修复]** BizyAir 模板清洗增强：对请求体做深度清洗，递归处理 `input_values/inputs`，清除空 `LoadImage.image` 字段并统一 URL 归一化。
- **[修复]** BizyAir 参考图兼容：本地中间件模式下将远程参考图优先内联为 `data:`，规避 Jimeng 签名链接在目标侧拉取失败。
- **[重构]** 持久化层改为优先存“源引用”：自动保存、历史压缩、项目/工作流导出在写入前将本地缓存/本地代理地址回写到源地址，由统一渠道函数在显示/请求时解析。
- **[优化]** 源引用解析性能：由逐项遍历历史改为预构建映射 O(1) 查找，降低自动保存/拖拽时主线程占用。
- **[修复]** 项目打包保存 quota 错误新增降级路径：失败后可一键改为“不含资产 JSON 保存”，避免整单保存失败。

#### 2026-02-08 开发中改动（3.8.6-rc4）
- **[修复]** Lightbox 导航增强：新增上下切组按钮（鼠标可用）与 `history_up/down_key` 调试日志，便于定位“上下无响应”问题。
- **[修复]** Lightbox 切图占位：切换图片/视频时优先清空旧资源并显示“加载中”，避免新图未就绪时残留上一张。
- **[修复]** 历史可导航状态扩展：将 `ok/succeeded/finished` 识别为可导航完成态，修复部分任务可预览但上下切组不可用。
- **[修复]** 模型库复制串参：复制模型时重建自定义参数 ID，避免 `zimagebase -> zimageturbo` 复用同 ID 导致参数串用。
- **[新增]** 自定义参数支持默认值：模型库参数可设默认值，节点面板可直接带默认并允许覆盖。
- **[新增]** 图像模型参数锁定：模型库新增“提交时不注入比例/分辨率”开关，避免模板参数互相干扰。

#### 2026-02-08 开发中改动（3.8.6-rc5）
- **[修复]** 降级保存不再二次调用 `showSaveFilePicker`：当 Zip 保存因 quota 失败并进入 JSON 降级时，强制走 `saveAs` 下载，避免 “Must be handling a user gesture” 报错。
- **[修复]** 模型切换串参收敛：切换模型时自定义参数改为按目标模型默认值重建，不再沿用旧模型已选值，修复 `base/turbo` 参数混用。
- **[优化]** 本地服务缓存策略：`/file` 媒体响应补充 `Cache-Control/ETag/Last-Modified`，`/proxy` 媒体响应覆盖 0ms TTL，减少大图重复下载。

#### 2026-02-09 开发中改动（3.8.6-rc6）
- **[新增]** 模型库默认参数增强：图片/视频模型支持默认比例、默认分辨率、默认时长；参数区默认下拉空值文案统一为“默认参数”。
- **[新增]** 智能分镜拆分升级：脚本区支持 `LLM拆脚本/LLM拆小说/LLM自定义` 三入口，新增 10,000 字计数与 Prompt 编辑模式三槽位（默认只读 + 记忆1/2）。
- **[新增]** 多图并发聚合：同一轮并发复用同一 `taskId`，多张结果汇聚到同一历史任务与同一预览窗口。
- **[新增]** 多图并发间隔：模型库新增 `并发间隔(秒)` 参数（默认 `2`），用于控制请求下发节奏并缓解 429。
- **[新增]** 多图并发 UI：AI 绘图节点在比例/分辨率右侧新增图片张数选择，支持 `1/2/4/9`（默认 `1`）。
- **[修复]** 参数禁用交互调整：模型标题处“禁用”移除；图片/视频参数区改为“标题旁禁用复选框”，比例项顺序为“禁用 -> 全比例”。
- **[修复]** 并发失败收敛：异步轮询/ModelScope/图像轮询失败改为批次收敛判定，避免单个子任务失败直接把整批标记失败。
- **[修复]** `zimagebase/zimageturbo` 自定义参数串候选：参数输入 `datalist` 改为模型/节点作用域 ID，消除同 `param.id` 跨模型串用。

#### 2026-02-09 开发中改动（3.8.6-rc7）
- **[版本]** RC 迭代规则恢复执行：本轮变更从 `3.8.6-rc6` 递增到 `3.8.6-rc7`，避免同 RC 持续叠加导致验收归因混杂。
- **[新增]** 模型库图片参数新增“默认张数（1/2/4/9）”，并写入模型导入导出、API 配置备份与项目保存链路。
- **[修复]** 图片节点切换模型时同步套用模型库默认张数；生成请求并发数回退链路补齐模型默认值。
- **[新增]** 智能分镜新增“卡片/表格”双视图与 Markdown 表格导入（支持从脚本文本或连接文本导入）。
- **[修复]** 智能分镜默认模式调整为图片模式（新建节点默认 `image`），并统一旧节点缺失模式时的默认回退逻辑。
- **[优化]** 智能分镜脚本输入框与 LLM Prompt 输入框支持用户纵向拖拽调整高度（`resize-y`）。
- **[文档]** 更新 `docs/improve/rc6_actual_workflow_upgrade_stages_20260208.md`，补充基于真实迭代状态的三阶段升级步骤。

#### 2026-02-09 开发中改动（3.8.6-rc8）
- **[版本]** 本轮为 RC7 后续验收补正，版本递增到 `3.8.6-rc8`，与上一轮改动分离。
- **[优化]** 智能分镜 Header 的“图片/视频”与“卡片/表格”切换按钮统一尺寸、圆角、主题下底色与激活态配色，三主题视觉一致性提升。
- **[新增]** 智能分镜表格视图支持手动维护：新增 `Markdown` 编辑区 + “应用/新增行/新增列”操作，不再仅依赖导入。
- **[新增]** 智能分镜表格支持直接编辑列头和单元格，编辑后自动回写 `tableData` 与 `tableMarkdown`。
- **[优化]** 表格视图下“导入表格”按钮语义强化：优先读取当前表格文本导入/刷新，确保按钮行为与当前视图一致。

#### 2026-02-09 开发中改动（3.8.6-rc9）
- **[版本]** 根据本轮验收反馈继续拆分版本，递增到 `3.8.6-rc9`。
- **[修复]** 智能分镜“导入”按钮合并为单入口：取消额外“导入表格”按钮，统一显示“导入”。
- **[修复]** 单入口导入改为按视图自适应：`卡片视图`导入关键帧图片，`表格视图`点击导入直接打开文件选择器并导入 Markdown 表格，避免表格模式下导入按钮灰置误导。
- **[优化]** 智能分镜默认表格骨架改为完整表头模板（场次镜号/时长/景别/运镜/.../片段视频），不再仅“镜头/描述”两列。
- **[优化]** 分镜相关标签与操作按钮配色统一：去除视频/表格/脚本/批量的高饱和分色，改为统一主题色体系（Solarized 下激活为深色、未激活为浅色）。

#### 2026-02-09 开发中改动（3.8.6-rc10）
- **[版本]** 按本轮继续迭代要求从 `3.8.6-rc9` 递增到 `3.8.6-rc10`，用于分离本次智能分镜增强验收。
- **[新增]** Antigravity 图像路由模式：模型库新增 `自动/仅Text-to-Image/仅Edit`，默认 `自动`（有参考图或蒙版走 edits，无参考图走 generations）。
- **[新增]** Antigravity Edit 参数对齐：`/v1/images/edits` 支持 `image1/image2/...` 多参考图上传，保留 `mask`，并同步提交 `size/aspect_ratio/image_size/quality`。
- **[修复]** Antigravity 单独 Edit 兜底：当模型设置为“仅Edit”但未连接参考图/蒙版时直接提示，避免静默走错端点。
- **[新增]** 智能分镜表格区新增 `LLM汇总` 按钮（位于“应用”左侧），可把景别/运镜/场景描述/人物动作等行信息汇总为提示词并回填到卡片镜头提示词。
- **[新增]** 脚本区在 `LLM自定义` 右侧新增“表格汇总 Prompt”编辑入口，用于自定义上条汇总能力的大模型提示词模板。
- **[新增]** Markdown 表格区新增折叠/展开能力，可收起下方 Markdown 输入框，仅保留表格操作区与表格内容区。
- **[修复]** 表格与卡片镜头号映射收敛：标准化 `场次镜号` 列并同步 `scene_index`，卡片序号显示改为优先读取 `scene_index`，保障表格与卡片一一对应。
- **[优化]** 表格折叠按钮改为符号标记（`^/v`），减少按钮文字占位。
- **[优化]** 文案统一：`LLM汇总` 按钮改为 `大模型汇总提示词`；脚本区图标入口改为文字按钮 `LLM分镜提示词汇总`。
- **[新增]** 表格单元格右下角新增 `↗` 放大编辑入口，点击后弹出 3x 宽高编辑器，可直接回写表格内容。
- **[优化]** 智能分镜脚本区按钮状态规则调整：非编辑状态下 `程序拆分` 与 `LLM拆脚本/LLM拆小说/LLM自定义` 均为浅色（程序拆分略深区分）；仅编辑模式下激活项变深色用于表示当前可编辑 Tab。
- **[优化]** 按验收反馈微调脚本区层级：`程序拆分` 恢复深色主按钮，`LLM拆脚本/LLM拆小说/LLM自定义` 在非编辑状态保持浅色，编辑模式激活态维持深色。

#### 2026-02-06 已验证（3.8.5）
- **[修复]** 智能分镜回填错误修复（shotId 匹配与映射修正）。
- **[修复]** 智能分镜超时错误修复（图片 60s / 视频 300s，最后一镜兜底）。
- **[修复]** 403 刷屏问题：缓存/代理与轮询遇 401/402/403 直接失败并回填。
- **[修复]** antigravity/Base64：data URL 规范化写入与回退，降低 ERR_INVALID_URL。
- **[新增]** 保存资产配置：历史保存上限可配置 + 90% 提示。
- **[优化]** 配置显示：悬浮显示 Provider / 完整模型名，配置信息展示更清晰。
- **[修复]** 批量下载进度显示修正，完成即显示 100%。
- **[优化]** 画布网格：缩放合并一次为大格，点阵颜色与晕染按反馈微调。
- **[修复]** Lightbox 历史导航过滤无效/裂图项，并增加纠错逻辑以降低跳跃。
- **[已知问题]** Lightbox 导航仍存在跳跃/不稳定（上下/左右），计划 3.8.6 修复。
- **[整理]** 本地服务移除 `tapnow-middleware.py`，以 full 版本为准。

#### 2026-02-06 开发中改动（3.8.5-rc4）
- **[新增]** 历史保存上限与 90% 提示逻辑。
- **[优化]** 历史面板：缓存设置/队列吸顶可操作。
- **[优化]** 下载进度条位置与显示格式调整。
- **[优化]** 网格点视觉与缩放合并逻辑迭代。
- **[修复]** Lightbox 历史导航过滤无效项，降低跳跃风险。
- **[优化]** 智能看板新增镜头默认不锁定。

#### 2026-02-05 开发中改动（3.8.5-rc3）
- **[修复]** ComfyUI 本地链接在缓存开启时统一走本地代理/缓存，避免直连 8188 导致刷新失效。
- **[修复]** 本地代理允许 127.0.0.1:8188/localhost:8188，用于 ComfyUI 输出回填与缓存。
- **[修复]** 历史记录 data: 被截断时自动回退原始 URL，避免 ERR_INVALID_URL。
- **[修复]** data: 超长 URL 不再持久化，避免刷新后落入无效地址。
- **[修复]** 分镜参数同步补齐 customParams。
- **[优化]** 分镜预览“暂定/重选”仅对有输出的镜头生效，空白不再默认全选。
- **[修复]** 脚本导入拆分新增镜头不再默认全选输出。
- **[修复]** 程序拆分新增镜头默认不全选输出，采用当前模式默认模型/比例。
- **[优化]** 模型 ID 输入阻断键盘事件冒泡，避免误触操作。
- **[修复]** 供应商模型 ID 不再过滤 jimeng，避免新增模型被误删。
- **[优化]** Lightbox 键盘导航忽略重复按键，降低跳跃切换。
- **[修复]** Lightbox 左右键加入节流，减少单次跳多张。
- **[修复]** 分镜批量生成在映射缺失时按 sourceNodeId 回填结果。
- **[修复]** 分镜批量超时上限分级：图片 60s / 视频 300s。
- **[优化]** 批量下载进度条增加打包阶段反馈。
- **[修复]** 缓存写入失败（含代理）记录失败源，避免 403 导致刷屏重试。
- **[修复]** 异步/ModelScope 轮询遇 401/402/403 直接失败并回填分镜，减少 403 刷屏。
- **[修复]** 异步图片轮询解析失败时的 delayMs 未定义问题。
- **[修复]** 修正 image 分支残留 `.catch`/括号导致构建失败（已构建验证）。
- **[修复]** 输出图片 Base64 规范化并优先写入 IDB，降低 ERR_INVALID_URL。
- **[文档]** 更新需求池/原文池/AG_STATE 记录 3.8.5-rc3 验收失败项。

#### 2026-02-05 开发中改动（3.8.5-rc2）
- **[修复]** 智能分镜回填逻辑补强（shotId 兼容与回填兜底）。
- **[修复]** 智能分镜批量超时修复（图片 60s / 视频 300s，最后一镜兜底）。
- **[修复]** 403 刷屏缓解：代理与轮询遇 401/402/403 直接失败回填。
- **[修复]** antigravity/Base64 规范化与回退，降低 ERR_INVALID_URL。

#### 2026-02-04 已验证（3.8.4）
- **[新增]** 本地 ComfyUI 中间件 v2.3：兼容 BizyAir/RunningHub 接口，补齐 create/detail/outputs。
- **[新增]** 本地 ComfyUI 测试指引文档（含 BizyAir/RunningHub/Prompt 三种测试路径）。
- **[新增]** workflows 批处理：单 JSON 自动重命名 template.json 并生成 meta.json。
- **[修复]** 本地文件访问遇到连接中止不再抛异常日志。
- **[修复]** workflows 批处理脚本兼容 cmd，避免内联 PowerShell 解析失败。
- **[优化]** 本地服务器恢复逐条请求日志输出。
- **[修复]** ComfyUI 响应解析支持 UTF-8 BOM（避免 Unexpected UTF-8 BOM 报错）。
- **[修复]** outputs/detail 允许用 prompt_id 作为 requestId 查询结果。
- **[修复]** ComfyUI /prompt 请求补齐 JSON header，并输出 400 错误体便于排查。
- **[修复]** 本地 ComfyUI 输入为空时不覆盖模板默认值，避免 400 校验失败。
- **[文档]** 合并模型库说明书与测试方法为统一版本，并在 README 引用。
- **[优化]** workflows 脚本自动生成常用参数映射（prompt/seed/steps/width/height/batch/sampler/scheduler）。
- **[优化]** 本地 ComfyUI 支持 seed=-1 自动随机。
- **[优化]** 本地 ComfyUI 多图输出等待稳定收集，batch_size 生效。
- **[整理]** 本地服务归档旧连接器，ComfyUI 版本作为根目录正式版本。

#### 2026-02-04 开发中改动（3.8.4-rc1）
- **[构建]** 生成 `dist/Tapnow Studio-V3.8.4-rc1.html` 构建产物。

#### 2026-02-02 已验证（3.8.3）
- **[新增]** 模型库：单模型导入/导出 + 复制模型快速复用配置。
- **[新增]** 模板变量扩展：支持 imageUrl1/2/3/4 等多图输入变量。
- **[优化]** 模型选择显示 Provider / Model ID，ChatImage 可在聊天与生图两端使用。
- **[优化]** 模板缺参兜底：raw 模式缺参自动填 `null`，避免 JSON 解析失败。
- **[修复]** 历史自定义参数提示名：有映射时仅显示提示名，隐藏 param-* ID。
- **[修复]** 多图输出持久化：output_images 刷新后保持多图显示（含缓存映射回填）。
- **[修复]** 图片生成模型显示：下拉与按钮显示“供应商 / 模型ID”。
- **[修复]** BizyAir 空参数处理：raw 模板空值不再输出 "null" 字符串，避免任务失败。

#### 2026-02-02 开发中改动（3.8.3-rc7，已并入 3.8.3）
- **[新增]** 模型库：Jimeng 视频模板默认启用，支持首尾帧 files 配置。
- **[新增]** 请求模板新增 bodyType=auto，自动在 json/multipart 间切换。
- **[新增]** 模型库异步任务通用轮询（asyncConfig），支持 create→detail→outputs 回填。
- **[优化]** 模板变量扩展：first/last frame、jimengRatio/jimengResolution/jimengDuration。
- **[优化]** 模板构建自动清理 undefined/null 字段，避免无效参数下发。
- **[修复]** 模型库默认模板初始化改为函数声明，避免 TDZ 导致启动黑屏。
- **[修复]** 请求模板启用时不再误走 Midjourney 专用分支。
- **[修复]** 相对 endpoint 拼接尾空格导致的 404/Not Found。

#### 2026-02-01 开发中改动（3.8.3-rc6，进行中）
- **[新增]** 接入 i18n 基础设施（i18next/react-i18next），加入 en.json 词表与脚本工具链。
- **[优化]** 模型库请求模板文案开始国际化处理，并修复模板预览中的异常 t() 包裹。
- **[新增]** 设置面板加入语言切换（中文/英文），并持久化到本地存储。
- **[新增]** 顶部工具栏加入语言切换按钮，便于快速切换。
- **[优化]** i18n 词库同步更新，修复缺失翻译条目。
- **[修复]** 语言切换时历史项/对比视图等 memo 组件可正确刷新。
- **[修复]** 默认语言强制为中文（无本地偏好时）。
- **[优化]** 补齐导入/全选/资产包/运行状态等文案的国际化显示。

#### 2026-02-01 开发中改动（3.8.3-rc5，待验证）
- **[修复]** 项目保存资产包开关生效，保存过程显示进度条。
- **[修复]** Jimeng 视频：文生视频回退 JSON 提交、图生视频输入更严格归一（含日志）。
- **[优化]** 黑屏防护：启动护栏 + ErrorBoundary + 全局错误捕获。
- **[优化]** Lightbox 导航与切换加入可追踪日志。
- **[修复]** Base64 图片 MIME 识别增强（避免 jpg/webp 误判为 png）。

#### 2026-02-01 开发中改动（3.8.3-rc4，待验证）
- **[修复]** 本地缓存可用性判断收紧：索引未就绪时不再假定可用，降低 404/无效命中。
- **[修复]** 代理判定与本地缓存共存：仅在本地缓存真实存在时绕开代理，避免应走代理却直连。
- **[修复]** 统一取图通道缓存优先级：`getBlobFromUrl` 仅在缓存可用时读取本地，否则回退原始/代理。
- **[修复]** 生成历史上下键跳组：改为线性顺序切换（不再环绕跳跃）。
- **[调整]** 项目保存改为优先资产包（ZIP）导出，避免 base64 超大或失败。
- **[构建]** 生成 `dist/Tapnow Studio-V3.8.3-rc4.html`。

#### 2026-01-30 开发中改动（3.8.3-rc3）
- **[修复]** 模型库折叠状态保存（导出/导入保持折叠）。
- **[调整]** 默认模型清理：移除 flux / modelscope / vibecoding 作为默认 provider。
- **[新增]** 启用缓存是否重新下载开关（默认 false）。
- **[调整]** Jimeng Sora2 图生视频与文生视频尝试修复（依赖模型库参数与首尾帧模式配置）。
- **[构建/备份]** `backups/src_backup_v3.8.3-rc3_finish_task_20260130-1353.zip`。

#### 2026-01-30 开发中改动（3.8.3-rc2）
- **[修复]** 缓存目录切换后刷新缓存触发流程（避免仅显示 toast 不执行）。
- **[修复]** 参考生图/代理图片使用统一取图通道（走代理或本地缓存）。
- **[调整]** 模型库参数映射/预览结构继续迭代（size/quality/ratio/duration）。
- **[构建/备份]** `backups/src_backup_v3.8.3-rc2_finish_task_20260130-0035.zip`。


#### 2026-01-29 开发中改动（3.8.3-rc1）
- **[修复]** 模型库参数上限提升到 30，备注映射与提示名显示规则优化。
- **[修复]** 历史模型名显示限制（15 字节）与悬浮提示显示 provider。
- **[修复]** 浏览选择缓存路径输入框联动（/pick-path）。
- **[调整]** AutoSave 优先写入 IndexedDB，localStorage 仅兜底。
- **[构建/备份]** `backups/src_backup_v3.8.3-rc1_finish_task_20260129-1712.zip`。


#### 2026-01-28 开发中改动（3.8.2，待验证）
- **[修复]** 缩略图重建统一走资源获取通道，避免 CORS 导致的 canvas 污染。
- **[调整]** 资源获取入口统一：本地缓存/代理/直连逻辑集中到 `getBlobFromUrl`。
- **[调整]** 批量下载改用统一资源获取通道（支持代理/本地缓存）。
- **[修复]** 黑屏：移除资源获取中的 TDZ 引用导致的初始化报错。
- **[修复]** 代理判定补充：推断 provider 大小写容错，避免漏走代理。
- **[修复]** 保存节点代理拉取使用本地服务地址，避免走直连触发 CORS。
- **[调整]** 缺图占位文字仅保留居中提示并放大字号。
- **[修复]** 本地缓存非激活时不再阻断代理判定，保存节点优先走代理或本地缓存。

#### 2026-01-28 已验证（3.8.2-rc3）
- **[调整]** 移除本地缓存自动触发的调试日志，减少控制台刷屏。

#### 2026-01-27 开发中改动（3.8.2-rc2）
- **[修复]** 缓存/代理/Base64 报错梳理与修复（ERR_INVALID_URL 收敛）。
- **[调整]** provider 代理规则：仅在启用代理时走 /proxy。
- **[调整]** 预览窗口浅黄底色、选择图片按钮深灰、分镜预览底色交替。
- **[构建/备份]** `backups/src_backup_v3.8.2-rc2_finish_task_20260128-0000.zip`。

#### 2026-01-26 开发中改动（3.8.2-rc1）
- **[修复]** 缓存路径选择与输入框联动（浏览/写入配置）。
- **[修复]** 模型库参数上限 30 + 参数备注映射 + 请求预览。
- **[修复]** 历史模型名显示限制与 provider 提示。
- **[构建/备份]** `backups/src_backup_v3.8.2-rc1_finish_task_20260127-1809.zip`。

#### 2026-01-23 已验证（3.8.1）
- **[修复]** 首屏黑屏报错：Cannot access '$s' before initialization。
- **[调整]** 黄色主题按钮选项统一去灰。
- **[调整]** 预览窗口图片展示区浅黄、选择图片按钮深灰。

#### 2026-01-31 开发中改动（3.8.1-rc7）
- **[修复]** Solarized 主题网格点由深黄恢复并随缩放/平移更新，防止画布黑屏重现。
- **[修复]** Solarized 节点外框深黄/内层浅黄，智能分镜与小说节点均用黄色系。
- **[修复]** 缓存代理提醒条新增关闭功能、刷新缓存会刷新指定目录，禁用缓存时不再重写本地文件。
- **[修复]** 自动保存与历史缩略图重建改为统一资源通道，避免 data URL 的 ERR_INVALID_URL 与 Base64 转 Blob 报错。
- **[调整]** 项目保存封包时上传图片前优先检查本地缓存（避免 502），并在界面显示打包进度。
- **[构建/备份]** 参考 `backups/src_backup_v3.8.3-rc3_finish_task_20260130-1353.zip`。

#### 2026-01-21 开发中改动（3.8.1-rc6，待验证）
- **[修复]** 队列按钮空白：补齐队列分组的 queued/running 初始化。
- **[调整]** Solarized 节点边框/智能分镜头尾/小说节点深浅层级。
- **[调整]** Solarized 蓝/绿按钮统一深灰色。
- **[调整]** Solarized 图片输入/图像对比背景改为较深黄。
- **[新增]** 模型库自定义参数（覆盖同名参数 + 请求预览）。
- **[新增]** 模型类型扩展：Chat Image 支持 + 模型类型紧贴名称展示。
- **[修复]** 模型库引用隔离：未引用条目不再受同名模型影响。

#### 2026-01-21 已验证（3.8.1-rc5）
- **[构建]** build 不再清空 dist，补回并保留 rc4 构建产物。

#### 2026-01-19 已验证（3.8.1-rc4）
- **[构建]** 生成 `Tapnow Studio-V3.8.1-rc4.html` 构建产物。
- **[备份]** finish_task 生成 rc4 源码备份（详见 `.waylog/finish_task_stamp.json`）。

#### 2026-01-19 开发中改动（3.8.1-rc2，待验证）
- **[调整] 版本标记**: 升级为 `3.8.1-rc2`。
- **[调整] 收尾备份**: `finish_task.ps1` 支持本地服务源码变更时额外备份。
- **[调整] 历史滚动条样式**: 亮色主题下滚动条滑块改浅灰。
- **[调整] 历史缩略图底板**: 亮色主题底板改浅灰，提示文字居中并指定字体回退。

#### 2026-01-18 开发流程改动（阶段二）
- **[新增] 收尾脚本**: 新增 `scripts/finish_task.ps1`，支持备份 ZIP、构建、AG_STATE 占位符写入与收尾时间戳。
- **[新增] 预检脚本**: 新增 `scripts/preflight.ps1`，检查阶段二必备文件与占位符。
- **[新增] 提交 Hook**: 新增 `.githooks/pre-commit` + `scripts/check_finish_task.ps1`，未运行脚本则阻止提交。
- **[新增] AG_STATE 自动块**: `docs/AG_STATE.md` 增加自动状态占位符区。
- **[新增] 轻量看板**: 新增 `kanban.json` 作为脚本可读写看板。

#### 2026-01-17 开发中改动（3.8.1-rc1）
- **[调整] 版本标记**: 升级为 `3.8.1-rc1` 开始新一轮开发。
- **[文档] API 接入规划**: 补充 Z-Image / Gemini 3 Pro Image Preview / Sora2 接入优先级说明。
- **[新增] ModelScope Z-Image 接入**: 异步生成 + /v1/tasks 轮询流程落地。
- **[新增] Gemini 3 Pro Image Preview 接入**: Yunwu Gemini native 图片生成接入。
- **[修复] ModelScope CORS**: 直连官方域名时不再强制添加 `X-ModelScope-*` 头，避免预检被拒。
- **[调整] 历史底部文字样式**: 文字居中、指定字体回退、亮色模式白底灰字。
- **[调整] ModelScope 异步兜底**: 请求体补充 `async_mode: true`，直连缺 Header 时给出代理提示。

#### 2026-01-17 发布版（3.8.0）
- **[调整] 版本标记**: 升级为 `3.8.0` 构建发布版。

#### 2026-01-16 开发中改动（待验证，rc4）
- **[调整] 版本标记**: 升级为 `3.8.0-rc.4`。
- **[调整] 分镜多图参考上限**: 图片模式多图参考位增加 1 个可用槽位。
- **[调整] 分镜右侧按钮列**: 继续右移居中，减少左侧偏移感。
- **[调整] 重建缩略图按钮**: 位置下移至删除下方，改为纯图标入口。
- **[新增] 历史拖拽扩展**: 历史资产可拖拽到图片输入/视频输入/关键帧/预览，拖到画布空白生成对应输入节点。
- **[新增] 发送到菜单整合**: 历史右键统一“发送到”并支持智能识别目标，子菜单提供画布/对话/预览入口。
- **[调整] 重建按钮布局**: 历史卡片重建按钮移动到删除下方，改为纯图标。
- **[新增] 全部重建缩略图**: 本地缓存面板新增“全部重建历史缩略图”按钮，提示文案精简。
- **[修复] 历史模型名显示**: 不再落到 Provider，优先显示模型名/ID。
- **[调整] 智能发送文案与宽度**: “发送到”改为“智能发送”，菜单宽度按最长文案收缩。
- **[调整] 智能发送子菜单悬停**: 悬停折叠按钮自动展开子菜单。
- **[修复] 智能发送节点识别**: 视频拆解/AI绘图/AI视频/图像对比可自动补输入节点并连线。
- **[调整] 智能发送子菜单顺序**: 子菜单顺序调整为“聊天/预览/画布”。
- **[修复] 智能发送子菜单延迟关闭**: 离开后延迟 1 秒关闭，方便移动到子菜单。
- **[新增] 智能发送聊天拖放**: 拖放图片到聊天面板自动添加附件。
- **[修复] 生成节点拖放**: 图像对比/AI绘图/AI视频拖放自动补输入节点并连线。

#### 2026-01-16 开发中改动（待验证）
- **[调整] 版本标记**: 升级为 `3.8.0-rc.2`。
- **[新增] 全局队列视图**: 生成历史新增全局队列弹窗，显示批次/线程与任务层级。
- **[新增] 队列单项删除**: 支持删除排队任务/终止运行任务，保留确认弹窗。
- **[修复] 选中下载逻辑**: 优先灰框勾选，再取图片勾选交集下载。
- **[调整] 右侧按钮区宽度**: 缩短按钮列宽度，减少右侧空隙。
- **[文档] 需求补录**: 增加历史拖拽/发送到菜单与历史预览异常的原文记录。
- **[调整] 全局队列面板**: 改为历史面板内嵌下拉样式，避免遮挡。
- **[新增] 队列模式开关**: 增加管线/并行切换按钮（全局队列）。
- **[修复] 性能模式默认关闭**: 默认打开不启用性能模式。
- **[修复] 历史预览取原图**: 预览/导航使用原图链路，避免小图马赛克。
- **[新增] 缩略图重建**: 历史条目增加“重建缩略图”按钮。
- **[调整] 历史标题布局**: 标题两行显示并收紧右侧按钮间距。
- **[调整] 右侧按钮居中**: 右侧按钮列进一步右移居中。
- **[新增] 空白分镜点击新增**: 分镜为空时点击空白区域直接新建镜头。

#### 2026-01-15 开发中改动（待验证）
- **[调整] 版本标记**: 升级为 `3.8.0-rc.1`，避免覆盖稳定版构建物。
- **[新增] 智能分镜批量下载**: 支持“全部/选中”下拉下载与 ZIP 打包命名。
- **[新增] 批量队列可视化**: 显示运行/排队清单，并提供清空排队与终止全部。
- **[调整] 主卡片右侧按钮**: 时间显示移入侧栏，删除按钮加确认，生成/上下移动按钮放大。
- **[新增] 分镜拖放**: 历史资产/URL/本地文件拖入镜头，适配多图参考与首尾帧。
- **[调整] 预览栏布局**: 预览列宽度加宽与折叠按钮对齐优化。
- **[调整] 局部重绘画笔**: 画笔渲染改为圆形显示。
- **[修复] 下拉菜单遮挡**: 批量下载/队列面板改为 Portal 浮层避免被节点裁切。
- **[修复] 局部重绘工具条**: 自动补齐图片尺寸，避免工具条消失。
- **[调整] 右侧按钮列对齐**: 图标居中对齐并适度放大以匹配新宽度。

## 📦 V3.7.x 系列 (智能分镜持续增强 API 错误处理与 Lightbox 优化)

### V3.7.36c (Batch Assets Fix C) - 2026-01-13
**构建文件**: `Tapnow Studio-V3.7.36c.html`
- **[修复] 模型名显示错误**: 批量素材卡片显示正确模型名并支持悬浮全名。
- **[修复] 四图预览**: 支持 MJ/多图输出的 2x2 网格展示。
- **[新增] 清理缓存按钮**: 批量清理本地缓存文件并同步清空缓存标记。
- **[优化] 参数信息同步**: 卡片信息展示类型/模型/比例/分辨率/时长/时间/耗时（24h + 分钟制）。
- **[优化] 视频时长记录**: 历史条目写入视频时长，便于批量信息展示。
- **[调整] 风格预设下拉**: 描述节点风格改为预设选择并自动更新提示词前缀。
- **[调整] 提示词优化模板**: 角色过滤与场景优化使用原版系统提示词模板。
- **[调整] 右键子菜单位置**: “提取角色和场景”子菜单改为右侧展开。
- **[修复] 36a 黑屏异常**: 修复 TDZ 顺序导致的初始化报错。
- **[调整] 生成节点模型双层选择**: 生成角色/场景图视频节点改为双层选择（已验证）。
- **[调整] 本地缓存路径与提示**: 移除 .tapnow_cache 兼容，统一 history，路径斜杠统一、提示常驻（已验证）。
- **[调整] 保存命名与多图**: 保存按“项目名-提示词-编号”，多图缓存强制唯一 ID（已验证）。
- **[调整] 保存去重**: 本地保存同图去重，按子文件夹隔离查重（已验证）。
- **[调整] 缓存去重与补全**: 多图缓存补全并复用同 URL 缓存避免重复下载（已验证）。
- **[调整] 性能模式按钮解耦**: 顶部性能模式与历史闪电互不联动（已验证）。
- **[调整] 双层下拉对齐**: 下拉上对齐 / 上拉下对齐，避免文字跳动（已验证）。
- **[调整] 批量素材交互**: 后端缓存标记、小图编号、双击预览、底部区域勾选（已验证）。
- **[调整] 本地缓存回退**: 预览链路 localCache > thumbnail > original，Lightbox/历史兜底（已验证）。
- **[调整] 本地缓存校验**: 本地文件缺失时清理“本地”标记与缓存映射（已验证）。
- **[调整] 角色图片提示词**: 图片模式移除口播描述，避免文字出现在画面（已验证）。
- **[调整] 角色/场景视频分辨率**: 增加 720/1080/不选 选项并记忆分辨率（已验证）。
- **[调整] 角色/场景视频时长校正**: Jimeng 时长强制 5/10s，避免 15s 报错（已验证）。
- **[文档] 需求归档与规划**: 需求池补录与优先级重排、原始需求归档清单、V3.8 规划文档同步。
- **[文档] 3.8 优先级调整**: 本版优先下载与 UI/分镜体验，其他待开发项标注 P0/1/2/3 并转下版。

### V3.7.36b (Local Cache/Save Fix B) - 2026-01-13
**构建文件**: `Tapnow Studio-V3.7.36b.html`
- **[新增] 历史面板本地缓存折叠菜单**: 显示连接状态与缓存设置入口。
- **[新增] 缓存路径配置**: 图片/视频保存路径可写回本地服务配置。
- **[新增] PNG 转 JPG**: 本地缓存支持开关与 PIL 可用性提示。
- **[新增] 缓存刷新**: 一键重置缓存标记，重新写入本地路径。
- **[新增] 保存节点服务地址**: local-save 支持独立服务地址与测试按钮。
- **[优化] 缓存路径判定**: 通过 save_path 判定默认/自定义缓存目录。

### V3.7.36a (Local Cache/Save Fix A) - 2026-01-13
**构建文件**: `Tapnow Studio-V3.7.36a.html`
- **[修复] 本地缓存非法文件名**: 清理 URL 文件名非法字符，避免 Windows 保存失败。
- **[修复] 缓存扩展名识别**: 按真实资源类型生成扩展名并提交 `/save-cache`。
- **[新增] 保存到本地手动保存**: local-save 节点新增待保存预览与手动保存按钮。
- **[修复] 自动保存落盘**: 自动保存改用 `/save-batch` 并转换为 Data URL 保存。
- **[修复] 待保存刷新**: 上游输出刷新时待保存列表同步更新。

### V3.7.35 (V2.6.1 Feature Merge) - 2026-01-12
**构建文件**: `Tapnow Studio-V3.7.35.html`
- **[合并] 本地缓存服务器**: 增加连接检测、历史/角色库自动缓存、本地缓存优先显示。
- **[合并] 工作流局部导出/导入**: 支持选中节点保存工作流并导入追加到画布。
- **[合并] 小说输入与角色场景提取**: novel-input / extract-characters-scenes 节点恢复并挂接右键菜单。
- **[合并] 保存到本地节点**: local-save 节点可用并恢复自动保存流程。
- **[合并] 性能模式缩略图**: 历史面板缩略图生成与本地缓存优先策略回补。
- **[新增] 小说拆分自动链路**: 提取后自动生成角色/场景描述 + 视频生成 + 创建节点，描述切图自动生成图片节点（待验证）。
- **[修复] 角色/场景描述增强**: 增加双层大模型选择、风格输入、多图参考与“增强/过滤提示词”动作。
- **[修复] 角色提示词修正**: 去除“角色设定/25岁”默认项，图片模式提示词不再携带 360 度展示语句。
- **[修复] 模式切换补链路**: 描述节点切换视频/图片模式时自动补齐对应生成节点。
- **[优化] 右键菜单收拢**: “提取角色和场景”作为父级，相关节点归入子目录。
- **[优化] 提取字段补全**: 小说提取结果支持 role/age/gender/style 等字段。

### V3.7.34 (Mainline Merge - 1006 + Jimeng Video Fixes) - 2026-01-12
**构建文件**: `Tapnow Studio-V3.7.34.html`
- **[合并] AI 生图节点返图缺失**: 同步返回路径不再依赖分镜任务映射，修复原始生图节点无法返图问题。
- **[合并] 图/视频分辨率隔离**: 非法分辨率自动规范化，避免图/视频参数互相污染。
- **[合并] 默认分辨率校准**: 图片默认 2K，视频默认 720p。
- **[合并] Jimeng 视频首尾帧**: multipart 使用 `image_file_1/2` 传首尾帧。
- **[合并] Jimeng 视频分辨率规范**: 统一 720p/1080p 小写映射。

### V3.7.33fix (Isolation Patch - Image Return Fix) - 2026-01-12
**构建文件**: `Tapnow Studio-V3.7.33fix.html`
- **[分支修复] AI 生图节点返图缺失**: 同步返回路径不再依赖分镜任务映射，修复原始生图节点无法返图问题。

### V3.7.33 (Smart Storyboard Timer Fix - Retry) - 2026-01-12
**构建文件**: `Tapnow Studio-V3.7.33.html`
- **[修复] 智能分镜时间显示 (0.0s Bug)**:

  - 修正了 `pollImageTask` 中的变量提升顺序问题，确保 `durationCost` 在更新 Node 前已正确计算。
  - 修复了 `pollSoraJob` / `pollVeoJob` 中的闭包陷阱，现在正确获取最新的 `startTime`。
  - 目标: 彻底修复任务完成后时间显示为 0.0s 的问题。
- **[修复] 智能分镜计时器刷新与停表**: 刷新频率提升至 100ms，任务完成/失败后停表并保留耗时，再次生成从 0 开始。
- **[新功能] 智能分镜时间显示**: 智能分镜表现在会自动根据镜头时长 (Duration) 计算并显示时间轴范围 (如 `00:00 - 00:05`)。
- **[Hotfix] API Model 输入框焦点丢失**: 修复了在 API 设置中编辑模型 ID 时，输入框每输入一个字符就失去焦点的严重 Bug。
- **[注意]**: 此版本正在进行 0.0s Bug 的持续修复验证。

### V3.7.32 (Console log Improvement) - 2026-01-11
**构建文件**: `Tapnow Studio-V3.7.32.html`
- **[代码优化] 日志清理**: 移除了 200+ 条冗余的 `console.log` 调试信息（包括 `[Batch]`, `[Debug]` 等），仅保留核心错误日志与生命周期提示，显著净化了控制台输出。
- **[性能微调]**: 减少了高频打印带来的浏览器控制台性能开销。
- **[Hotfix] 安全修复**: 修复了视频生成时因 `blob:null` 导致的 Security Error。将内部图片管理 (`LocalImageManager`) 升级为严格使用 **Base64 Data URIs**，彻底绕过 `file:///` 协议下的跨域限制。

### V3.7.31 (Logic & Batch Stability) - 2026-01-10
**历经 5 次内部迭代修复，当前构建文件**: `Tapnow Studio-V3.7.31.html`
- **[P0 修复] 锁定镜头仍触发任务**: 彻底修复了灰色框锁定的镜头（`outputEnabled=true`）仍被加入批量队列的问题。批量生成逻辑现在会严格跳过已锁定镜头。
- **[P1 修复] 键盘导航初始化**: 解决了切换到新历史组后，第一次按右键无反应的问题。通过确保 `currentIndex` 在切换组时正确重置。
- **[优化] 批量生成逻辑**: 多次迭代优化了批量生成的过滤条件，确保只有“未锁定且未生成”的镜头进入线程。
- **[UI] 状态同步**: 完善了批量生成按钮的状态反馈，确保任务结束后状态能正确归位。
- **[代码集成]**: 标志着智能分镜逻辑在稳定性上的一次重大里程碑。

### V3.7.30 (UI State Synchronization) - 2026-01-10
**历经 5 次核心逻辑迭代，构建文件**: `Tapnow Studio-V3.7.30.html`
- **[P0 修复] 预览回填故障**: 彻底解决分镜生成后预览图不回填、转圈不停止的问题。经历从 `setTimeout` 兜底到直接物理调用 `setNodes` 的多次试验。
- **[逻辑优化] 竞态消除**: 修复了在高频多任务并发时，节点状态会被过期数据覆盖的问题。
- **[增强] 调试机制**: 引入了 `[V3.7.30 Debug]` 明确日志标识，实现对生成结果流向的精准追踪。
- **[修复] 转圈不停止**: 确保在 API 失败或中断时，Loading 状态面板能正确卸载。
- **[稳定性] 全量同步**: 此版本标志着本地开发环境与同步代码库的完美对齐。

### V3.7.29 (Major Stability Iterations) - 2026-01-10
**包含 7 次快速迭代修复，构建文件**: `Tapnow Studio-V3.7.29.html`
- **[架构修复] 状态竞态覆盖**: 为超时检测逻辑增加了 `onlyIfStatus: 'generating'` 条件，防止已成功的状态被超时逻辑错误回滚。
- **[逻辑修复] 强制重试机制**: 修复了手动点击“强制重试”时未完全重置状态的问题。确保状态同步变更为 `pending` 并非虚假触发。
- **[UI 修复] 模型联动假象**: 移除了过时的 `localStorage` 自动兜底逻辑，强制显示分镜自身的 `shot.model` 属性，解决模型显示不同步的困扰。
- **[交互增强] 全方位右键支持**:
    - 分镜卡片现在全面支持 2x2 格子、1+3 布局及单图的右键预览菜单。
    - 在 `previewContextMenu` 中新增了 **“下载原图”** 功能。
- **[任务管理] 三选项中断弹窗**: 针对卡住或生成缓慢的镜头，提供了 **终止 / 跳过 / 放弃** 三种细分处理逻辑。
- **[数据流] 异步回填完整化**: 回填时支持一次性传递全部 4 张输出图片（针对 Midjourney/即梦等模型）。
- **[UI 优化] Toast 通知**: 将全局 Toast 位置从 `top-4` 移至 `top-20`，避免遮挡顶部操作栏。
- **[预览增强] 快捷交互**: 主图和 2x2 格子支持通过双击直接唤起 Lightbox 灯箱预览。

### V3.7.24 - V3.7.28 (Stability Iterations)
**Internal Release Sequence**: 
> *These versions were part of the rapid stability iteration cycle leading to V3.7.29.*
- **V3.7.28**: 预备发布 V3.7.29 的前置优化，整合状态管理逻辑。
- **V3.7.27**: 修复分镜生成中的状态回滚问题，增强异常捕获。
- **V3.7.26**: 调整 Toast 通知层级与样式，优化视觉反馈。
- **V3.7.25**: 优化右键菜单触发逻辑，解决部分交互冲突。
- **V3.7.24**: 初步尝试修复多任务竞态条件 (Race Condition)。

### V3.7.23 (Jimeng API Error Handling) - 2026-01-08
**构建文件**: `Tapnow Studio-V3.7.23.html`
- **[P0 修复] 1000 止损**: 参数错误立即停止生成，不轮换、不入黑名单。支持 `realErrorCode===1000` 和 `invalid parameter` 文本匹配。
- **[P0 修复] 1006 精确匹配**: 仅当 `realErrorCode===1006` 才入黑名单。新增熔断保护（2分钟内10次触发全局熔断）。
- **[P1 新增] 34010105 登录失效分流**: 登录失效错误不再入黑名单，改为暂停列表（TTL 60分钟）。
- **[P1 新增] 参数预校验**: ratio/resolution 白名单校验，不合法立即报错，0 次 API 请求。
  - 支持 ratio: `1:1`, `4:3`, `3:4`, `16:9`, `9:16`, `3:2`, `2:3`, `21:9`
  - 支持 resolution: `1k`, `2k`, `4k`
- **[P2 新增] 设置管理按钮**: API 设置对话框新增"清空黑名单"、"清空暂停列表"、"重置熔断"按钮。
- **[优化] 错误日志**: 保留 `rawMessage` 和 `realErrorCode` 便于回溯调试。

### V3.7.22 (Lightbox Navigation Fix) - 2026-01-08
**构建文件**: `Tapnow Studio-V3.7.22.html`
- **[关键修复] Lightbox 导航状态污染**: 修复了快速按键导致的索引过时问题，使用立即同步 `itemRef.current` 更新。
- **[关键修复] 历史记录与分镜预览冲突**: 历史记录调用时设置 `storyboardContext: null`，避免状态污染。
- **[修复] 1006 误判**: 视频生成改用精确正则匹配提取错误码。
- **[修复] 1000 错误处理**: 参数错误立即停止，不再尝试其他 key。

### V3.7.21 (Storyboard Preview Fix) - 2026-01-08
**构建文件**: `Tapnow Studio-V3.7.21.html`
- **[修复] 四小图预览可导航**: 添加 `mjImages` 和 `storyboardContext` 支持左右键切换。
- **[修复] shotIndex 修正**: 使用 `findIndex(s => s.id === shot.id)` 获取正确镜头索引。
- **[修复] 上下键导航**: 切换镜头后左右键功能正常。

### V3.7.20 (MILESTONE - Provider Logic Refactor) - 2026-01-08
**构建文件**: `Tapnow Studio-V3.7.20-MILESTONE.html`
- **[里程碑] Jimeng Provider 逻辑重构**: 在隔离分支完成 Jimeng Provider 架构重大重构。
- **[重构] 统一 Provider 管理**: 合并了 Jimeng 系列模型的 Provider 配置逻辑，实现统一管理。
- **[优化] 模型加载机制**: 重构模型配置加载流程，确保所有 Jimeng 模型（图像/视频）正确识别和加载。
- **[修复] 配置兼容性**: 解决了模型配置在不同场景下的兼容性问题。
- **[稳定] 基础版本**: 作为后续开发的稳定基础，所有关键功能验证通过。
- **[备份] 关键节点**: `src_backup_v3.7.20_MILESTONE.zip`, `src_backup_v3.7.20_isolated_branch.zip`

### V3.7.3 - V3.7.19 (快速迭代版本)
**主要更新**：
- **V3.7.19**: 全面修复综合问题
- **V3.7.18**: 模式切换修复
- **V3.7.17**: UI 修复
- **V3.7.16**: 下游节点连接修复
- **V3.7.15**: 布局修复
- **V3.7.14**: 最终布局优化
- **V3.7.13**: 面板按钮修复
- **V3.7.12**: 按钮和 UI 修复
- **V3.7.11**: 分镜相关修复
- **V3.7.10**: 新增输出面板功能
- **V3.7.9-6**: UI 和功能优化
- **V3.7.5**: UI 修复准备
- **V3.7.4**: 分镜逻辑修复
- **V3.7.3**: 功能迭代

> 详细信息见 `docs/CHANGELOG_DETAILED_RECOVERY.md`

### V3.7.2
- **UI Adjustment (Image)**: 恢复了图片大预览图右下角的"多图参考开关" (Layout Icon)。
  - **Logic**: 关闭时隐藏下方缩略图，开启时显示。
- **UI Adjustment (Video)**: 移除了参数栏中的蓝色"首尾帧"复选框 (保留了预览图右下角的分叉开关)。
- **Core Fix**: 增强了图片预览修复逻辑，确保导入的 `file://` 图片能立即被转换为 Blob 显示。

### V3.7.1
- **UI Logic Update (Image Mode)**: 修正了多图参考的交互逻辑。
  - **Exclusive Display**: 缩略图列表中不再显示当前的大图。
  - **Swap Interaction**: 点击下方小图，该图"上台"成为大图，原大图"下台"回到列表位置。
  - **Visual Feedback**: 完美匹配用户提供的交互图解 (左/中/右状态)。

### V3.7.0 (Major Update)
- **UI Refactor (Image Mode)**: 重构了多图参考模式，采用 "舞台(Stage) + 缩略图(Thumbnails)" 布局。
  - **Stage**: 上方大图显示当前激活的图片。
  - **Thumbnails**: 下方列出所有参考图 (最多4张)，点击切换舞台显示。
  - **Interaction**: 明确了“点击小图上台，大图下台”的交互逻辑。
- **Core Fix (Data Flow)**: 
  - 实现了 `file://` 路径到 `blob:` 的自动转换与状态同步。
  - 彻底解决下游节点无法读取导入图片的问题。
- **Fixes**: 修复了视频预览高度、首尾帧开关及导入错误。

## 📦 V3.6.x 系列 (智能分镜增强，Provider重构)

### V3.6.9
- **UI Logic Update**: 恢复了首尾帧分叉图标开关（右下角悬浮显示，带 Tooltip），移除了参数栏 Checkbox。
- **Layout Fix**: 修复了预览图在部分情况下塌陷的问题 (`min-height` fix)。
- **Image Data Fix**: 自动修复 broken image 后会同步更新节点数据，确保下游节点能读取到有效链接。

### V3.6.8
- **Critical Fix**: 修复了参数栏 (Parameters Row) 禁止换行导致模型选择器 (Model Selector) 无法弹出的问题。恢复为 `flex-wrap`。
- **Import Fix**: (From 3.6.7) 修复关键帧导入图片加载失败问题 (Blob Recovery)。
- **Height Fix**: (From 3.6.7) 预览区域高度自适应 (h-full)。
- **Lightbox**: (From 3.6.7) 调整 Lightbox Header 位置。

### V3.6.7
- **Import Fix**: 修复关键帧导入图片加载失败问题 (Blob Recovery)。
- **Height Fix**: 预览区域高度自适应 (h-full)。
- **Lightbox**: 调整 Lightbox Header 位置。

### V3.6.6
- **UI Adjustment**: 
  - **Remove Toggle**: 移除了多余的首尾帧开关，完全由参数栏 Checkbox 控制。
  - **Lightbox**: 大图预览的标题栏和关闭按钮移至底部 (Bottom)。
  - **No Wrap**: 强制参数行 (Parameters Row) 不换行。
  - **Height Fix**: 修复预览区域高度显示问题。
  - **Fix**: 修复了代码重复导致的构建错误。

### V3.6.5
- **UI Logic Update**: 
  - **首尾帧开关**: 移至首帧右下角，改为 Checkbox 样式，更符合用户预期。
  - **Header Fix**: 彻底禁止 Header 换行，使用 `overflow-x-auto`。
  - **Image Recovery**: 尝试修复导入关键帧后由 File Protocol 限制导致的 broken image (尝试调用 `LocalImageManager`)。
  - **UI Cleanup**: 尾帧激活模式下隐藏不必要的关闭按钮。

### V3.6.4
- **UI Polish**: 调整了按钮布局以符合用户习惯：
  - **关闭按钮**: 右上角 (Top-Right)。
  - **预览大图**: 左下角 (Bottom-Left)。
  - **分屏开关**: 右下角 (Bottom-Right) - 仅在悬停时显示。
- **UX**: 默认视图更加简洁，去除了非必要的 "+" 按钮，仅通过右下角开关启用首尾帧/多图模式。

### V3.6.3
- **UI Enhancement**: Video 模式分屏逻辑优化。现在支持“激活帧”概念：
  - **默认状态**: 首帧大图显示（类似旧版），右侧无干扰。
  - **分屏模式**: 支持点击右侧 "+" 开启尾帧。激活的帧（首或尾）显示为大图，非激活帧显示为侧边小图。点击小图可切换。
  - **功能回归**: 恢复了大图的“预览”按钮和上传功能。
- **Fix**: 修复了图片上传无响应的问题。

### V3.6.2
- **UI Refresh**: 重构 Smart Storyboard 输入区域，将首尾帧（Video）和多图参考（Image）整合到主 Shot Card 中，移除冗余面板。
- **Feature**: 视频模式下支持左右分屏显示首尾帧，图片模式下支持缩略图列表和拖拽排序。
- **Fix**: 修复了图标引用问题。

### V3.6.1 (Smart Storyboard UX) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.6.1.html`
- **[UI 重构] 智能分镜输出预览**: 移除了卡片内部的内嵌预览区，改为在节点右侧弹出独立的**输出预览面板**。面板支持缩略图预览、全选和批量输出功能。
- **[UI 重构] 引用图与首尾帧**:
  - **视频模式**: 首尾帧现在显示为两个独立的 4:5 卡片（左首帧，右尾帧），布局更清晰。
  - **图片模式**: 多图参考区域重设计为主图预览 + 底部缩略图列表，支持轻松管理多张参考图。
- **[功能] 动态参数适配**: 比例选择器现在根据模式（图片/视频）自动切换选项内容（视频支持 'Auto' 比例）。分辨率选择器也实现了动态适配。
- **[功能] 批量生成增强**: Storyboard 顶部的批量生成按钮现在全面支持**图片模式**，可一键批量生成所有图片镜头。
- **[修复] IIFE 闭合**: 修复了智能分镜节点渲染逻辑中可能导致崩溃的闭合括号问题。

### V3.6.0. (Fix3) MILESTONE - Storyboard Features - 2026-01-07
**构建文件**: `Tapnow Studio-V3.6.0.fuckedup.html`
- **[重要修复] 模型名称显示**: 彻底修复 V3.6.0 模型配置重构导致的 UI 显示 `undefined` 问题。
- **[重要修复] 构建报错 (JSX Syntax)**: 修正分镜表操作栏多余 `</button>` 标签。
- **[功能增强] 模型记忆同步**: 分镜表选定模型自动同步为全局"上次操作模型"。

### V3.6.0  - 2026-01-07
**构建文件**: `Tapnow Studio-V3.6.0-MILESTONE.html`
- **[里程碑] 智能分镜功能重构**: 大规模重构分镜编辑器。
- **[重构] 模型配置简化**: 简化 API 配置架构，供应商和模型双渠道彻底重构简化
- **[备份] 关键节点**: `src_backup_v3.6.0_before_storyboard_features.zip`


## 📦 V3.5.x 系列 (功能增强)

### V3.5.37 (Hotfix) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.37.html`
- **[关键修复] 即梦视频生成 Bug**: 修复了即梦视频生成接口中缺失 `model` 参数的问题。现在无论文生视频还是图生视频，系统都会正确传递用户选择的模型 ID（如 3.5-pro, veo3 等），而不是无法识别。同步修复了 JSON 模式下分辨率参数的缺失。

### V3.5.39 - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.39.html`
- **[修复] 全面修复**: 综合修复多个问题
- **[重构前备份]**: 重大重构前的稳定备份点

### V3.5.38 - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.38.html`
- **[修复] 比例修复**: 修复图片/视频比例相关问题

### V3.5.36 (Global Persistence & Model Info) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.36.html`
- **[重要修复] Video Input 崩溃**: 修复了视频输入节点在点击展开/收起按钮时，由于 `framesCount` 未定义导致的 `ReferenceError` 页面崩溃问题。
- **[新增] 全局参数持久化**: 实现了各节点参数（比例、分辨率、分析模型、分段时长）的全局记忆。现在新建任何节点都会自动继承用户最后一次设定的配置，并在 `localStorage` 中永久保存。
- **[优化] 即梦模型历史显示**: 历史记录中，即梦系列模型现在直接显示其精确的 `modelId` (如 `jimeng-4.5`, `jimeng-video-3.0`)，方便开发者和用户精确识别。
- **[重要修复] 分镜脚本拆分**: 彻底解决了 `showManualInput` 与 `scriptExpanded` 状态冲突导致的按钮失效问题。同时将“程序拆分”增强版正则同步至快捷导入逻辑中，全面恢复并强化了脚本解析能力。
- **[优化] 历史记录显示**: 精简了历史项的信息密度。默认不再直接展示供应商名称，仅保留“时间 · 模型名”。鼠标悬停在模型名上时，即可通过气泡提示查看详细的供应商信息。
- **[重要修复] 默认模型库校准**: 全面同步了即梦 (Jimeng) 全系列模型。新增了 3.5 Pro, Veo3/3.1 (固定 8s), Sora2 以及 2.0 系列视频模型；图像类新增了 4.5/4.1/4.0 系列、NanoBanana 系列及 XL Pro 等，确保默认配置涵盖所有最新可用接口。
- **[重要修复] 分镜脚本拆分**: 彻底重构了分镜拆分正则表达式，现在支持 `#1`, `【1】`, `1.` 等多种标号格式，并解决了跨行内容匹配失败的问题。
- **[优化] 节点默认尺寸**: 系统性增大了所有生成类节点的初始宽度（约 20%），并同步调整了关键帧网格的分裂阈值，使卡片展示更加宽敞舒适。
- **[优化] 默认模型库**: 移除了 Banana, Sora, Google Veo 等冗余默认配置，保持模型列表精简。用户仍可通过 UI 自行添加。
- **[优化] 供应商名称显示**: 历史记录面板现在正确显示 Provider 的友好名称（如：“Jimeng 即梦”），与 API 配置保持高度一致。
- **[安全] 源码自动备份**: 本轮修改前已自动执行 `src` 目录 ZIP 备份 `src_backup_v3.5.36_before_fixes.zip`。

### V3.5.35 (Stability & API) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.35.html`
- **[重要修复] 批量下载重名冲突**: 修复了历史记录批量下载时，相同 Prompt 的项目会导致文件名冲突并互相覆盖的问题。现在文件名会自动附带任务 ID 后缀。
- **[新增] 即梦视频模型**: 新增了 Jimeng 3.0 Pro, Std, Fast 全系列视频生成模型选项。
- **[优化] 关键帧分裂阈值**: 调大了视频输入节点关键帧网格的分裂阈值（从 140px 增加到 220px），使卡片在宽屏下依然能保持较大的展示面积，减少过早分裂成多列。
- **[规范控制] 源码备份**: 严格执行任务开始前的 `src` 完整备份。

### V3.5.34 (UX Polish) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.34.html`
- **[优化] 默认尺寸**: 调大了视频输入节点的默认初始宽度（480px）和高度（460px），确保新建节点时预览图比例更自然（对应图一）。
- **[修复] 累计误差**: 精确校准了高度计算公式，彻底解决了多帧列表时底部裁剪的问题。

### V3.5.33 (Layout Fix) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.33.html`
- **[修复] 布局间隙**: 修复了视频输入节点关键帧卡片垂直间距过大的问题（添加 `content-start items-start`）。
- **[优化] 关键帧卡片**: 关键帧卡片在折叠模式下自动改为单列展示，并限制高度为 90px，呈现“长方形压缩”效果。
- **[优化] 自动调整高度**: 点击收起/展开按钮时，程序会自动计算并更新节点高度，模拟用户手动调整，确保完整展示内容。
- **[修复] 清空按钮**: 修复了清空按钮在某些情况下换行的问题（V3.5.32 遗留）。

### V3.5.32 (Hotfix) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.32.html`
- **[修复] 清空按钮**: 添加whitespace-nowrap确保按钮文字不换行。
- **[修复] 节点高度锁定**: 移除动态高度计算，恢复用户可调整高度功能。
- **[修复] 卡片间隙**: 恢复wrapper为简单relative样式，让grid gap正常工作。
- **[验证] 视频API**: 使用jimeng-api工具测试确认API调用正常，错误2060是服务端问题非客户端。

### V3.5.31 (Bug Fixes) - 2026-01-07
**构建文件**: `Tapnow Studio-V3.5.31.html`
- **[修复] 拖拽插入线**: 重构插入线为wrapper结构，红线现在正确显示在卡片边缘而不被overflow:hidden裁剪。
- **[修复] 清空按钮**: 添加flex-nowrap防止"清空"按钮换行。
- **[修复] 视频错误2060**: 添加对Jimeng API错误码-2008和2060的友好错误提示，详细说明可能原因。
- **[修复] 双任务Bug**: 添加_isRetry和_existingTaskId选项，API Key失效重试时跳过history创建，防止重复任务。
- **[新功能] 折叠高度动态计算**: 视频输入节点收起视频播放器时，节点高度自动收缩为：banner(40) + 按钮(40) + 标题(28) + 网格(行数*96) + padding(24)。

### V3.5.27 - V3.5.30 (快速迭代版本)
> 这些版本为快速迭代修复，主要包含：
> - 视频输入节点 UI 和交互优化
> - 批量生成和历史记录功能改进
> - 错误处理和日志增强

### V3.5.26 (Bug Fixes) - 2026-01-06
**构建文件**: `Tapnow Studio-V3.5.26.html`
- **[修复] Video Input**: 修复了“全选”按钮无法联动显示的问题 (Ref Object Logic)。
- **[优化] Video Input**: 允许无视频状态下手动折叠/展开区域；优化了图片列表的自动对齐和显示。
- **[功能] Storyboard**: 增加了 "清空所有分镜" 按钮 (垃圾桶图标)。
- **[交互] Nodes**: 修复了双击节点会误触画布菜单的问题。

### V3.5.25 (UI Polish) - 2026-01-06
**构建文件**: `Tapnow Studio-V3.5.25.html`
- **[修复] UI**: 删除了 Storyboard 头部多余的 `)}` 字符。
- **[优化] Storyboard**: 批量生成按钮增加 "批量" 文字标识。
- **[新功能] 视频输入**: 缩略图列表增加 "全选/取消" 按钮，方便批量操作关键帧。
- **[UI 优化] 视频输入**: 调整了关键帧卡片上的操作按钮布局（右侧垂直排列：选择-删除-排序）。

### V3.5.24 (Feature Release) - 2026-01-06
**构建文件**: `Tapnow Studio-V3.5.24.html`
- **[UI 优化] Storyboard**: 移除了冗余的 "脚本拆分" 横幅，将其输入面板改为由头部按钮直接控制显示。
- **[新功能] 批量生成**: 在 Storyboard 头部增加了 "批量全部生成" 按钮 (Zap图标)。
- **[新功能] 并发控制**: 支持设置批量生成的并发数量 (0=全部, N=队列限制)。

### V3.5.23 (Layout Fix) - 2026-01-05
**构建文件**: `Tapnow Studio-V3.5.23.html`
- **[UI 修复] 视频输入节点**: 移除了上传区域的 `flex-1` 属性，解决了在节点高度变化时上传框异常拉伸或产生巨大留白的问题。现在上传框高度严格固定。

### V3.5.22 (Emergency Hotfix) - 2026-01-05
**构建文件**: `Tapnow Studio-V3.5.22.html`
- **[紧急修复] 拖拽崩溃**: 修复了 `dragOverNodeId is not defined` 导致的页面崩溃。
- **[功能恢复] 脚本拆分**: 恢复了 Storyboard 节点的 "脚本拆分" (Script Splitter) 功能，并优化了智能合并逻辑。

### V3.5.21 (Hotfix) - 2026-01-05
**构建文件**: `Tapnow Studio-V3.5.21.html`
- **[严重修复] 生成崩溃**: 修复了点击生成按钮导致页面黑屏 (`Square is not defined`) 的错误。
- **[UI 修复] 视频上传**: 视频输入节点的上传区域现在限制为固定大小方框，不再占用过多垂直空间。

### V3.5.20 (MILESTONE - Performance Optimization) - 2026-01-05
**构建文件**: `Tapnow Studio-V3.5.20.html`, `Tapnow Studio-V3.5.20-Rebuild.html`, `Tapnow Studio-V3.5.20-RestoredTest.html`
- **[里程碑] 专项性能优化**: 从 Rebuild 到 RestoredTest 进行了大规模性能优化和体积优化。
- **[性能] 构建体积优化**: 
  - **Rebuild 版本**: 重构构建流程，优化代码分割和打包策略
  - **RestoredTest 版本**: 进一步压缩和优化，显著减小最终文件体积
  - 优化资源加载和缓存策略
- **[性能] 运行时优化**:
  - 优化组件渲染性能，减少不必要的重渲染
  - 改进大列表渲染效率
  - 优化内存使用和垃圾回收
- **[修复] IndexedDB 图片**: 修复了 IndexedDB 图片导致的 "Failed to fetch" 错误。
- **[新增] 停止/取消生成**: 单个分镜现在支持停止生成。
- **[优化] 视频输入节点**: 修复了宽度问题，增加了特定区域拖拽插入关键帧功能 (带插入线)。
- **[优化] Storyboard**: 移除了脚本拆分 Header，增加了分镜间隙点击插入新分镜功能。
- **[UI]**: 为截断的文件名和长描述添加了 Tooltips。
- **[验证]**: 三个版本用于验证性能优化效果和恢复流程。
- **[备份]**: `src_backup_v3.5.20_AppOnly.zip`

### V3.5.3 - V3.5.19 (快速迭代版本)
**主要更新**：
- **V3.5.14**: 修复画布拖拽问题
- **V3.5.10-19**: 视频输入节点功能完善
- **V3.5.3-9**: 分镜编辑器基础功能开发

**功能亮点**：
- 拖拽排序和插入线功能
- 历史记录和批量下载
- 模型选择器和参数记忆
- UI 修复和交互优化

> 详细信息见 `docs/CHANGELOG_DETAILED_RECOVERY.md`

### V3.5.2 - 2026-01-04
**构建文件**: `Tapnow Studio-V3.5.2.html`
- **[修复] 分镜视频生成**: 修复 `Params body.duration invalid` 错误，确保 duration 格式正确 (如 `5s`)。
- **[修复] 历史选择框**: 选择按钮现在始终可见，点击即时更新状态。
- **[新增] 分镜分辨率**: 智能分镜表生成视频时现在传递 resolution 参数。
- **[调试] 详细日志**: 添加了选择按钮和生成参数的调试日志。

### V3.5.1 - 2026-01-04
**构建文件**: `Tapnow Studio-V3.5.1.html`
- **[修复] 历史选择框样式**: 改为与关键帧一致的圆形设计 (绿色 CheckCircle2)。
- **[修复] 模型选择器高度**: 下拉菜单高度从 192px 增大到 320px，避免滚动。
- **[调试] 下载功能**: 添加详细日志追踪下载按钮点击和批量下载流程。
- **[构建] 输出格式**: 自动输出为 `Tapnow Studio-V3.x.x.html` 格式。
- **[文档] 智能分镜使用指南**: 新增 `docs/storyboard_usage.md` 详细说明模块用法。

### V3.5.0 - 2026-01-02
**构建文件**: `Tapnow Studio-V3.5.0.html`
- **[新增] 视频分辨率选择**: AI视频节点和智能分镜表新增 720p/1080p 分辨率选择器 (Jimeng/Grok 模型)。
- **[新增] ZIP批量下载**: 历史面板多选下载现在打包为 ZIP 文件，自动包含 Midjourney 4宫格全部变体。
- **[优化] 视频播放**: Lightbox 播放器添加控制条，历史面板视频使用 `preload="metadata"` 优化加载。
- **[优化] 导出文件名**: API 配置导出文件名改为 `tapnow-api-keys-YYMMDD-HHmm.json` 格式。

---

## 📦 V3.4.x 系列 (关键修复)

### V3.4.26 (MILESTONE - V3.4.x Stable) - 2026-01-02
**构建文件**: `Tapnow Studio-V3.4.26.html`, `Tapnow Studio-V3.4.26-MILESTONE.html`
- **[里程碑] V3.4.x 系列稳定版**: V3.4 系列的最终稳定版本，集成了所有关键修复。
- **[修复] 视频 URL 格式**: 支持 Jimeng API 返回 `data: [{url: "..."}]` 的数组格式。
- **[稳定] 功能完善**: 
  - Provider 配置架构稳定
  - 黑名单机制完善
  - 模型选择器优化完成
  - 历史记录功能稳定
- **[基础] 为 V3.5 铺路**: 作为 V3.5 系列开发的稳定基础版本。
- **[备份]**: `Tapnow Studio-V3.4.26-MILESTONE.html`

### V3.4.17 - V3.4.25 - 2026-01-02
**构建文件**: `Tapnow Studio-V3.4.17.html` - `Tapnow Studio-V3.4.25.html`
- **快速迭代版本**: 包含多个 bug 修复和功能优化
- **主要改进**:
  - Provider 配置优化
  - 模型选择器改进
  - 历史记录功能完善
  - UI 交互优化
  - 各种 bug 修复

### V3.4.16 (Latest) - 2026-01-02
**构建文件**: `Tapnow Studio-V3.4.16.html`
- **[新增] 历史分隔线**: 历史面板现在显示“本次生成”和“之前生成”分隔线。
- **[新增] 历史卡片选择框**: 右下角添加选择按钮，支持多选下载。
- **[修复] Provider删除bug**: 删除的Provider不再重新出现。
- **[修复] 空图片节点显示**: 空图片节点连接到视频拆解现在正确显示关联信息。

### V3.4.15 - 2026-01-02
**构建文件**: `Tapnow Studio-V3.4.14.html`
- **[修复] 提示词生成报错**: 修复 `config is not defined` 错误，添加 config 变量定义。

### V3.4.13 - 2026-01-02
**构建文件**: `Tapnow Studio-V3.4.13.html`
- **[新增] 图片提示词反推**: 图片输入节点现在可连接到"视频拆解/提示词反推"节点，图片作为单帧处理。
- **[备份] V3.4.12源代码**: 创建 `src_backup_v3.4.12.zip`。

### V3.4.12 - 2026-01-02
**构建文件**: `Tapnow Studio-V3.4.12.html`
- **[修复] 批量下载重做**: 使用 Blob 下载避免页面跳转，修改菜单为"本次生成/全部资产"，添加下载进度条。
- **[修复] 画布层叠彻底修复**: 使用最后一个 input-image 节点位置作为基准，真正实现扑克牌式左下展开。
- **[新增] 本次会话追踪**: 添加 sessionStartTime 状态追踪本次会话生成的资产。
- **[新增] 历史选择状态**: 添加 historySelection 为后续多选功能做准备。

### V3.4.11 - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.11.html`
- **[新增] 分镜双层模型选择器**: 智能分镜表的视频模型选择器现在使用 Provider -> Model 双层菜单，支持区分同名模型的不同渠道。
- **[新增] 历史批量下载**: 历史记录面板新增下载按钮，支持"全部下载"和"仅本项目"两种模式。
- **[修复] 画布层叠效果**: 优化发送到画布的层叠检测算法，检测范围从 50px 增大到 100px，偏移量增大到 35x30，实现更明显的扑克牌式展开。
- **[文档] 首尾帧使用指南**: 新增首尾帧功能使用说明文档。

### V3.4.10 - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.10.html`
- **[修复] 历史记录多图显示**: Jimeng 等模型生成的多张图片现在正确保存到 localStorage，刷新/新窗口后仍显示全部图片。
- **[修复] 发送到画布层叠**: 发送图片到画布时，自动向左下方层叠 (左-30, 下+25)，像扑克牌一样展开。
- **[新增] 双层模型选择器**: 视频拆解和角色提取节点现在使用 Provider -> Model 双层菜单选择模型。

### V3.4.9 - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.9.html`
- **[修复] 分镜/视频拆解模型选择器**: 所有模型选择器现在显示 `modelName` 而非 `provider`。
- **[修复] Chat 模型选择器**: 统一修复所有 Chat 类型模型选择器的显示格式。

### V3.4.8 - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.8.html`
- **[重构] Provider 配置架构**:
  - API Key 和 Base URL 现在统一从 **Provider** 配置获取。
  - 模型不再单独保存 key/url，而是继承其所属 Provider 的配置。
  - 新增 `getApiCredentials(modelId)` 统一凭据获取逻辑。
- **[优化] Settings Modal**:
  - 模型列表现在显示和编辑 **modelName** (实际 API 调用名称)，而非 displayName。
  - 字体改为等宽字体，更方便识别模型 ID。
  - **模型类型 (Chat/Image/Video) 现在可选择**，恢复之前的编辑功能。
  - **所有模型都可删除**，删除后供应商也可正常删除。
- **[修复] 模型分组迁移**: 现有用户的模型 provider 分配会自动更新为最新默认值。
- **[修复] 测试连接**: 现在正确使用 Provider 的 Base URL 进行连接测试。
- **[修复] Modal 关闭**: 改用 `onMouseDown` 关闭弹窗，修复拖拽时误触关闭的问题。
- **[新增] 模型记忆**: 创建 AI 绘图/视频节点时，默认选择上次使用的模型。
- **[修复] 节点模型显示**: 节点底部的模型选择器显示 `modelName` (等宽字体) 而非 `displayName`。

### V3.4.7 - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.7.html`
- **[优化] 默认模型分组**:
  - `OpenAI` 组现在包含所有 GPT 模型及 `Sora 2` 系列。
  - `Google` 组现在包含 `Gemini` 系列及 `Veo 3`、`Nano Banana`。
- **[优化] 配置导出**: 导出文件 (`.json`) 现已包含完整的**供应商配置 (Providers)**，且版本号更新为 `3.4.7`。
- **[修复] 供应商管理**: 包含 Hotfix 6 的所有修复 (行内删除确认、无缝添加、防误触关闭)。
- **[修复] 撤销/重做**: 包含 Hotfix 4 的所有修复 (批量删除撤销)。

### V3.4.6 - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.6.html`
- **[新增] 撤销/重做功能**: 支持 Ctrl+Z (撤销) 和 Ctrl+Shift+Z (重做)，最多保存 3 步历史。顶部栏新增撤销/重做按钮。
- **[新增] API Key 导出/导入**: 设置面板新增 "API 配置备份" 区域，支持导出和导入所有 API 配置（含 Keys）。
- **[修复] 项目名称初始化**: 点击"清空"或加载项目时，项目名称会正确重置为"未命名项目"。

### V3.4.5 (V2.6.1 Merge) - 2026-01-01
**构建文件**: `Tapnow Studio-V3.4.5.html`
- **[合并] V2.6.1 实验室特性**: 全面集成 V2.6.1 版本的创新功能：
  - **性能模式**: 支持 "关闭/标准/极致" 三档性能调节，优化长列表渲染卡顿。
  - **本地保存**: 新增 `local-save` 节点，支持配合本地服务自动保存生成结果到硬盘。
  - **小说分析**: 新增 `novel-input` (大文本输入) 和 `extract-characters-scenes` (角色提取) 节点，支持 LLM 辅助创作。
- **[修复] 构建修复**: 修复了合并过程中引入的 JSX 结构错误和语法问题。
- **[UI]**: 设置面板新增 "V2.6.1 实验室功能" 分区，支持全局 API Key 配置。

### V3.4.4 (Latest) - 2025-12-31
**构建文件**: `Tapnow Studio-V3.4.4-DisplayName-Fix.html`
- **[修复] Model Selector 显示**: 节点底部的模型选择器现在优先显示 `displayName` (如 "jimeng 4.5")，解决了之前只显示 provider 导致无法区分模型的问题。
- **[修复] 代理错误码解析**: 增加了从 `message` 中提取真实错误码的逻辑 (如 `错误码: 1006`)，解决了代理服务包装错误导致的 1006 检测失效。

### V3.4.3 - 2025-12-31
**构建文件**: `Tapnow Studio-V3.4.3-Debug.html`
- **[修复] 1006 检测优化**: 改用松散比较 (`==`) 并添加 DEBUG 日志，解决了错误码类型不匹配导致的黑名单失效。

### V3.4.2 - 2025-12-31
**构建文件**: `Tapnow Studio-V3.4.2-Deep-Fix.html`
- **[修复] Blob URL 智能恢复**: 在生成前尝试恢复内存中的 Blob 数据，修复了页面未刷新时的图片失效问题。
- **[修复] 初始 Key 过滤**: 初始 API Key 选择现在会过滤掉黑名单中的 Key。

### V3.4.1 - 2025-12-31
**构建文件**: `Tapnow Studio-V3.4.1-Blob-Fix.html`
- **[修复] 画布 Blob 根治**: `sendFrameToCanvas` 和九宫格切割改用 Base64 Data URL，彻底解决了保存后图片失效的问题。
- **[文档]**: 输出 `feature_evaluation.md` 评估文档。

### V3.4.0 - 2025-12-31
**构建文件**: `Tapnow Studio-V3.4.0.html`
- **[修复] 黑名单同步**: 引入 `apiBlacklistRef` 解决并发请求下的黑名单状态同步问题。

---

## 📦 V3.3.x 系列 (架构与功能)

### V3.3.1 - 设置面板增强
- **[新增]**: 设置面板新增 `displayName` 编辑功能。
- **[新增]**: 模型类型选择器 (Chat/Image/Video)。
- **[新增]**: Provider 下拉选择支持。

### V3.3.0 - Provider 架构重构
- **[重构]**: 引入 `DEFAULT_PROVIDERS` 和 `providers` 状态管理。
- **[新增]**: 支持 Jimeng 4.0 / 3.0 等新模型配置。
- **[新增]**: `localStorage` 持久化 Provider 配置。

---

## 📦 V3.2.x 系列 (Failover 修复)

### V3.2.0 - Failover Blacklist Fix - 2025-12-30
**构建文件**: `Tapnow Studio-V3.2.0-Failover-Blacklist fix.html`
- **[修复] Failover 黑名单**: 修复 API Failover 黑名单机制问题。
- **[优化] 错误处理**: 改进错误处理和重试逻辑。

---

## 📦 V3.1.x 系列 (Failover 黑名单)

### V3.1.0 - Failover Blacklist - 2025-12-30
**构建文件**: `Tapnow Studio-V3.1.0-Failover-Blacklist.html`
- **[新增] API Failover**: 实现 API Key 自动切换机制。
- **[新增] 黑名单机制**: 添加失败 API Key 黑名单功能。
- **[备份]**: `Tapnow Studio-V3.1.0-Failover-Blacklist-BACKUP.html`

---

## 📦 V3.0.x 系列 (现代化重构)

### V3.0.0 - Modern Secure - 2025-12-28
**构建文件**: `Tapnow Studio-V3.0.0-Modern-Secure.html`
- **[里程碑] 现代化重构**: 全面重构代码架构。
- **[安全] 安全增强**: 加强安全性和数据保护。
- **[UI] 现代化界面**: 更新 UI 设计和交互。

---

## 📦 V2.6.x 系列 (Legacy 版本)

### V2.6.1 - Secure Legacy - 2025-12-27
**构建文件**: `Tapnow Studio-V2.6.1-Secure-Legacy.html`
- **[安全] 安全修复**: Legacy 版本安全修复。
- **[稳定] 稳定版本**: 最后的 V2.x 稳定版本。

### V2.6.0 - Original - 2025-12-27
**构建文件**: `Tapnow Studio-V2.6.0-Original.html`
- **[基础] 原始版本**: V2.x 系列基础版本。
- **[功能] 核心功能**: 包含核心图片/视频生成功能。
## 📦 V2.6.x 系列 (Legacy 版本)

### V2.6.1 - Secure Legacy - 2025-12-27
**构建文件**: `Tapnow Studio-V2.6.1-Secure-Legacy.html`
- **[安全] 安全修复**: Legacy 版本安全修复。
- **[稳定] 稳定版本**: 最后的 V2.x 稳定版本。

### V2.6.0 - Original - 2025-12-27
**构建文件**: `Tapnow Studio-V2.6.0-Original.html`
- **[基础] 原始版本**: V2.x 系列基础版本。
- **[功能] 核心功能**: 包含核心图片/视频生成功能。

---

# 🎯 里程碑版本功能详解

## V3.7.23 - 2026-01-08
**主题**: Jimeng API 错误处理全面优化

### 核心功能
**P0 - 关键修复**
- **1000 参数错误止损**: 检测到参数错误立即停止，不进行无意义的 API Key 轮换，避免浪费配额
  - 支持 `realErrorCode===1000` 精确匹配
  - 支持 "invalid parameter" 文本匹配
  - 不将 Key 加入黑名单（因为是参数问题，非 Key 问题）
  
- **1006 积分耗尽精确判定**: 仅当 `realErrorCode===1006` 时才判定为积分耗尽
  - 新增熔断保护：2分钟内10次 1006 错误触发全局熔断
  - 详细日志：保留 `rawMessage` 和 `realErrorCode` 便于调试
  - 避免误判：1000、34010105 等其他错误不会被误判为 1006

**P1 - 重要功能**
- **34010105 登录失效分流**: 登录失效错误不再永久拉黑
  - 加入临时暂停列表（TTL 60分钟）
  - 自动过期恢复可用
  - 提示用户刷新 session
  
- **参数预校验**: 请求前验证参数合法性
  - ratio 白名单: `1:1`, `4:3`, `3:4`, `16:9`, `9:16`, `3:2`, `2:3`, `21:9`
  - resolution 白名单: `1k`, `2k`, `4k`
  - 不合法立即报错，0 次 API 请求

**P2 - 管理增强**
- **设置管理按钮**: API 设置对话框新增三个管理按钮
  - 清空黑名单（显示当前数量）
  - 清空暂停列表（显示当前数量）
  - 重置熔断计数器

### 适用场景
- 大量 API Key 管理
- 批量生成任务
- 多账号轮换使用
- 错误诊断和恢复

---

## V3.7.20 (MILESTONE) - 2026-01-08
**主题**: Jimeng Provider 架构重大重构

### 核心功能
**Provider 统一管理**
- **架构重构**: 在隔离分支完成 Jimeng Provider 配置逻辑的全面重构
- **统一管理**: 合并了 Jimeng 图像模型和视频模型的 Provider 配置
- **模型加载优化**: 重构模型配置加载流程，确保所有模型正确识别
  - Jimeng 图像系列: 4.5, 4.1, 4.0, NanoBanana 等
  - Jimeng 视频系列: 3.5 Pro, Veo3/3.1, Sora2 等

**兼容性改进**
- 解决模型配置在不同场景下的兼容性问题
- 统一 API Key 和 Base URL 管理
- 优化模型选择器显示逻辑

**稳定基础**
- 作为后续开发的稳定基础版本
- 所有关键功能验证通过
- 完整备份：`src_backup_v3.7.20_MILESTONE.zip`

### 适用场景
- 需要使用多个 Jimeng 模型
- Provider 配置管理
- 稳定的开发基础

---

## V3.6.0 (MILESTONE) - 2026-01-07
**主题**: 智能分镜功能重构 + Provider 双渠道架构

### 核心功能
**智能分镜编辑器**
- **大规模重构**: 完全重构分镜编辑器架构
- **UI 优化**: 更直观的分镜管理界面
- **批量操作**: 支持批量生成、批量编辑

**Provider 双渠道架构**
- **供应商和模型分离**: 彻底重构简化配置架构
- **双层选择器**: Provider → Model 双层菜单
- **灵活配置**: 支持同名模型的不同渠道

**功能亮点**
- 脚本拆分功能
- 首尾帧支持
- 多图参考模式
- 输出预览面板

### 适用场景
- 视频分镜创作
- 批量图片/视频生成
- 多渠道 API 管理

---

## V3.5.20 (MILESTONE) - 2026-01-05
**主题**: 专项性能优化

### 核心功能
**构建体积优化**
- **Rebuild 版本**: 重构构建流程
  - 优化代码分割策略
  - 改进打包配置
  - 优化资源加载

- **RestoredTest 版本**: 进一步压缩
  - 显著减小最终文件体积
  - 优化缓存策略
  - 资源懒加载

**运行时性能优化**
- **渲染性能**: 减少不必要的组件重渲染
- **大列表优化**: 改进历史记录、分镜列表渲染效率
- **内存管理**: 优化内存使用和垃圾回收

**功能修复**
- 修复 IndexedDB 图片导致的 "Failed to fetch" 错误
- 新增停止/取消生成功能
- 视频输入节点拖拽插入关键帧

### 性能提升
- 文件体积减小约 15-20%
- 首屏加载速度提升
- 大列表滚动更流畅
- 内存占用降低

### 适用场景
- 大量历史记录
- 复杂分镜项目
- 性能敏感场景

---

## V3.4.26 (MILESTONE) - 2026-01-02
**主题**: V3.4.x 系列最终稳定版

### 核心功能
**Provider 配置架构稳定**
- API Key 和 Base URL 统一管理
- Provider 继承机制完善
- 模型分组和迁移

**黑名单机制完善**
- `apiBlacklistRef` 并发同步
- 每日自动重置
- 失败 Key 自动切换

**模型选择器优化**
- 显示 `modelName` 而非 `provider`
- 等宽字体便于识别
- 双层菜单支持

**历史记录功能稳定**
- 多图显示支持
- 批量下载功能
- 历史分隔线

### 集成修复
- 视频 URL 数组格式支持
- Provider 删除 bug 修复
- 画布层叠效果优化
- 撤销/重做功能

### 适用场景
- 需要稳定可靠的基础版本
- 多 Provider 管理
- 历史记录管理

---

## V3.0.0 (MILESTONE) - 2025-12-28
**主题**: 现代化重构

### 核心功能
**代码架构重构**
- 全面重构代码结构
- 模块化设计
- 组件化开发

**安全增强**
- 数据保护加强
- API Key 安全存储
- 输入验证

**现代化界面**
- 更新 UI 设计
- 改进交互体验
- 响应式布局

### 适用场景
- 现代化应用基础
- 安全性要求高的场景

---

## V3.7.34 (MILESTONE) - 2026-01-12
**主题**: Timer Stabilized

### 核心功能
- **计时器刷新更细**: 0.1s 级刷新，显示更顺滑。
- **完成停表**: 任务完成或失败后停止计时并保留耗时。
- **重生成归零**: 每次重新生成从 0.0s 开始计时。

### 适用场景
- 智能分镜长任务计时与回填稳定性验证

---

# 📊 版本选择建议

| 使用场景 | 推荐版本 | 原因 |
|---------|---------|------|
| **日常使用** | V3.7.35 | V2.6.1 功能回补后的最新主线 |
| **大量 API Key** | V3.7.35 | 熔断保护，智能轮换 |
| **性能敏感** | V3.5.20 | 专项性能优化 |
| **分镜创作** | V3.6.0+ | 智能分镜功能完善 |
| **稳定开发** | V3.7.20 | Provider 架构稳定 |
| **基础稳定** | V3.4.26 | V3.4 系列最稳定 |

---

*最后更新: 2026-01-28*  
*当前版本: V3.8.2*
