# Storyboard Debug13 修复 Knowhow（2026-02-11）

## 1. 问题定义

- `debug13-a`：智能分镜参考小图删除会误清空整镜头；小图缺少独立预览/删除操作。
- `debug13-b`：上下游分镜串联后，单镜头参考图操作会污染其他镜头（多镜头联动错误）。

## 2. 复现场景

1. 在智能分镜节点中开启多图参考。
2. 任意镜头插入第 2 张参考图，或切换“多图参考”状态。
3. 观察其他镜头参考图和开关状态被同步污染。
4. 在小图区域点击删除，观察整镜头主图与参考图被清空。

## 3. 根因分析

### 3.1 `debug13-b` 根因

- `isSameShotId` 采用了“数字 token 模糊匹配”策略。
- 对 `shot-<timestamp>-0/1/2` 这类 ID，会提取到同一数字 token，导致 `updateShot` 误命中多个镜头。
- 结果：对单镜头的 `referenceImages/useMultiRef/image_url` 更新被扩散为全镜头更新。

### 3.2 `debug13-a` 根因

- 主图删除逻辑直接写入 `{ image_url: '', image_filename: '', referenceImages: [] }`，没有“仅删当前项”的分支。
- 多图缩略图缺少“预览按钮 + 删除按钮”，只能通过切主图绕行操作。

## 4. 修复策略

## 4.1 镜头 ID 比较收敛

- 改为“严格字符串相等”为主。
- 仅保留“纯数字 ID”兼容比较，不再对复合字符串做 token 模糊匹配。
- 结果：`updateShot` 仅更新目标镜头，不再跨镜头串写。

## 4.2 参考图交互收敛

- 主图删除改为：
  - 若仍有其他参考图：提升下一张为主图；
  - 若无其他图：再清空镜头输入。
- 缩略图新增：
  - 预览按钮（`Maximize2`）；
  - 删除按钮（`X`）；
  - 双击缩略图预览。
- 点击缩略图仍保留“切换为主图（交换顺序）”行为。

## 5. 代码落点

- `src/App.jsx`
  - `isSameShotId`：ID 比较逻辑收敛（避免跨镜头误命中）。
  - 分镜卡片输入区：主图删除、多图缩略图预览/删除、上传写回逻辑修复。

## 6. 验收结果

- 单镜头参考图新增、删除、切主图，不再影响其他镜头。
- 删除第 2/3 张参考图不会清空整镜头。
- 小图支持按钮预览与双击预览。
- 构建与 smoke 通过，`3.8.7-rc8` 产物可生成。

## 7. 回归建议

1. 单节点 5 镜头，逐镜头开启/关闭多图参考，确认状态互不串联。
2. 每镜头插入 2~4 张参考图，验证删除第 2 张/第 3 张仅影响当前镜头。
3. 串联上游分镜后导入参考图，确认下游镜头数据仍按镜头隔离。
4. 验证小图点击（切主图）与双击（预览）行为不冲突。
